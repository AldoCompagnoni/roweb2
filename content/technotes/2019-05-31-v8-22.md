---
slug: v8-22
title: 'The invisible work behind an R package'
date: '2019-05-31'
authors:
  - Jeroen Ooms
categories: technotes
tags:
  - R
  - V8
  - packages
  - Javascript
---

The R package [V8](https://cran.r-project.org/web/packages/V8/index.html) implements bindings to Google's [V8](https://v8.dev/) JavaScript engine. We use this to wrap JavaScript libraries in R, such as rOpenSci packages [jsonld](https://docs.ropensci.org/jsonld/) and [jsonvalidate](https://docs.ropensci.org/jsonvalidate/).


Earlier [this year](https://ropensci.org/technotes/2019/02/11/v8-20/) I blogged about a major update of the V8 R package that would use the version of libv8 embedded in nodejs. I'm very pleased to say that by now this solution has landed in the stable branches of Fedora 30 (released last month) and the Debian Buster (to be released soon).

Over the past years, maintaining the V8 bindings has been quite a headache, even though the R interface hasn't changed. A lot of work goes into keeping up with changes in the upstream C++ library. In this post I'd like to share a writeup of the story and show some insight the (mostly invisible) work that goes on behind the scenes in maintaining complex open source systems.

### Google and Open Source

I maintain R bindings for several Google open source libraries, including V8, tesseract, cld3, webp, brotli, and protocol buffers. Obviously we are very happy that Google open sources these projects, but the way this is done makes it obvious that the libraries are primarily intended for internal use at Google. This has been particularly painful in the case of V8.

Google develops V8 as the JavaScript Engine for their browser, Google Chrome, which has a 6 week release cycle. Because V8 is embedded with Chromium, the developers do not care about backward compatibility. The C++ API has little documentation and breaking changes for every version, which makes it very difficult to develop applications or bindings that build on the library.

Consequently, major Linux distributions such as Debian and Fedora had given up on updating their libv8 many years ago, as doing so would break reverse dependencies every time. Because R needs support for Debian and Fedora, the only V8 C++ api we could use in the R bindings was the stale version 3.14 which is available on Debian/Ubuntu [libv8-dev](https://packages.ubuntu.com/bionic/libv8-dev) and Fedora/CentOS [v8-314-devel](https://apps.fedoraproject.org/packages/v8-314-devel). 

V8 version 3.14 implemented ECMAscript version 5 (ES5), which is the JavaScript language spec from 2009. This was fine for a while, however JavaScript is changing fast, and many JS libs now require more recent features. The situation became increasingly pressing because V8 3.14 would crash when compiled with recent versions of GCC, and had many unresolved [security problems](https://tracker.debian.org/pkg/libv8-3.14). It was basically considered broken beyond repair, and was eventually removed from Debian. CRAN requires that all R packages can be checked on Debian, so this put the R bindings in immediate jeopardy.

### Why not just bundle the V8 library

Several people had suggested: [_"why not just bundle V8 with the R package"_](https://github.com/jeroen/V8/issues/9). Indeed, one approach to release an R package with bindings to a library that is not available from the OS, is by including the library code with the package, and compile it together with the bindings. This works well for packages with small, portable C libraries, such as [brotli](https://cran.r-project.org/web/packages/brotli/index.html) or [jsonlite](https://cran.r-project.org/web/packages/jsonlite/index.html).

Unfortunately, here is the other bad news: _one does not just build V8_. Where most C++ libraries have converged to cmake or autotools for building a library, Google libraries use a series of internal tools and python scripts that are automatically downloaded from google servers during the build process. Just like V8 itself, these build tools are constantly changing, and something that works today may not work tomorrow. They also seem to continuously invent new build systems; in the past few year V8 has gone from `gyp` to `scons` and now uses a combination of `gn` and `ninja` to build.

In addition to complex, V8 is also an incredibly heavy library. Building it can easily take more than an hour on a single core machine, and by default will start building custom versions of libicu and libcxx as part of the process.

```
brew reinstall v8 --build-from-source
```

To get a sense what is involved with building V8, try the above line on MacOS using homebrew. The process involves downloading 7 custom tools from Google servers, all your CPU cores spinning at 100%, and by the time it is done your macbook is overheated and your coffee is cold.  

Obviously none of this matters if you're Google and you just need to push out a build every 6 weeks. However the volatile build system and high hardware requirements make it impossible to bundle V8 code with the R bindings in a portable and robust way.


### NodeJS to the rescue

How did this get resolved? Fortunately for us, there is another major open source project that builds on V8, namely NodeJS. Like Chromium, NodeJS also embeds V8, but with two major differences:

 - NodeJS provides LTS releases which contain a fixed branch of V8 with a stable API
 - NodeJS has an option to build the embedded V8 as a shared library

Because [nodejs](https://packages.debian.org/buster/nodejs) was already in Debian, its Debian maintainer offered to refactor the deb package to split out the embedded V8 into a separate package [libnode-dev](https://packages.debian.org/buster/libnode-dev), that we could link to from R. After a few iterations, we made it all work and I am very excited that as of Debian Buster, the R bindings from the [r-cran-v8](https://packages.debian.org/buster/r-cran-v8) package now use the V8 engine from libnode.

Following Debian's example, a few months later the Fedora maintainers made [similar changes](https://src.fedoraproject.org/rpms/nodejs/pull-request/4) to the [nodejs](https://apps.fedoraproject.org/packages/nodejs) rpm package, which now provides a shared engine in v8-devel as of Fedora 30. Hence as of last month, R users installing the Fedora [R-V8](https://apps.fedoraproject.org/packages/R-V8) package will be using the LTS V8 engine from nodejs.

### V8 on MacOS

Crisis averted on Linux, however the majority of R users actually run Windows and MacOS. Because these systems do not have a native package manager, we need to provide a suitable prebuilt version of V8 to build the R package. 

On MacOS the situation is quite good: up-to-date binaries for V8 are available from Homebrew, and they are usually fine. There have been a few problems in the past because V8 defaults to linking a custom C++ stdlib (for reasons beyond my understanding) which will then conflict with the one in R, but all of this has been sorted out for now.

I used a modified version of the homebrew formula to build a static version of libv8, which we then again use for building the R binary package. Thereby R users on MacOS can install the V8 package which contains both bindings and the library in a single precompiled standalone binary.

### And then Windows...

